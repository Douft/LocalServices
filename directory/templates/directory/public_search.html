{% extends "base.html" %}
{% load siteads_tags %}

{% block title %}Search{% endblock %}

{% block content %}
  <h1 style="margin-top:0;">Search services</h1>
  <p class="muted">Start typing, then optionally refine with filters.</p>

  <div class="card" style="max-width: 720px; margin: 16px auto 0;">
    <form id="public-search-form" method="get" style="margin:0;" data-live-search="1" data-live-search-url="/search/live/" data-live-search-target="#live-providers-results" data-live-search-min-query="1" data-live-search-hide-when-empty="0">
      {{ location_form.latitude }}
      {{ location_form.longitude }}

      <div style="display:flex; gap: 10px; align-items: end;">
        <div style="flex:1;">
          <label>Search</label>
          {{ search_form.query }}
        </div>
        <div>
          <button class="btn btn-primary" type="submit">Search</button>
        </div>
      </div>

      <div class="spacer-12"></div>
      <details>
        <summary class="muted" style="cursor:pointer;">Filters</summary>
        <div class="spacer-12"></div>
        <div class="form-grid">
          <div>
            <label>Category</label>
            {{ search_form.service_category }}
          </div>
          <div>
            <label>City</label>
            {{ location_form.city }}
          </div>
          <div>
            <label>Province/State</label>
            {{ location_form.state }}
          </div>
          <div>
            <label>Postal code</label>
            {{ location_form.postal_code }}
          </div>
          <div>
            <label>Radius</label>
            {{ location_form.radius_km }}
          </div>
        </div>
        <div class="spacer-12"></div>
        <div class="muted" style="font-size: 12px;">Tip: allow browser location for nearby results (requires HTTPS or localhost in most browsers).</div>
      </details>
    </form>
  </div>

  <div style="max-width: 980px; margin: 16px auto 0;">
    <h2 style="margin: 0;">Results</h2>
    <div id="live-providers-results">
      {% include "directory/_live_results.html" with providers=providers suggested_providers=suggested_providers external_providers=external_providers external_error=external_error external_source=external_source %}
    </div>
  </div>

  <script>
    (function () {
      try {
        var form = document.getElementById('public-search-form') || (document.currentScript && document.currentScript.previousElementSibling);
        if (!form || !form.querySelector) return;

        var latInput = form.querySelector('input[name="latitude"]');
        var lonInput = form.querySelector('input[name="longitude"]');
        if (!latInput || !lonInput) return;

        // Prefer current form values over URL params, because the server may
        // default location from a profile without the URL containing those keys.
        var cityInput = form.querySelector('input[name="city"]');
        var stateInput = form.querySelector('input[name="state"]');
        var postalInput = form.querySelector('input[name="postal_code"]');

        var hasLocation = (postalInput && postalInput.value) || ((cityInput && cityInput.value) && (stateInput && stateInput.value));
        var hasCoords = (latInput && latInput.value) && (lonInput && lonInput.value);
        if (hasLocation || hasCoords) return;

        if (!navigator.geolocation) return;
        if (window.isSecureContext === false) return;
        navigator.geolocation.getCurrentPosition(function (pos) {
          latInput.value = String(pos.coords.latitude);
          lonInput.value = String(pos.coords.longitude);
          form.submit();
        }, function () {
          // User denied or unavailable: fall back to manual filters.
        }, { enableHighAccuracy: false, timeout: 6000, maximumAge: 300000 });
      } catch (e) {
        // Ignore.
      }
    })();
  </script>

  {% ad_unit "search_inline_1" %}

{% endblock %}
