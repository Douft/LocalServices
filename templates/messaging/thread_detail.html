{% extends "base.html" %}

{% block title %}{{ thread.subject }} · Messages · Local Services{% endblock %}

{% block content %}
  <div class="container">
    <div class="glass" style="padding: 18px;">
      <div style="display:flex; gap:12px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;">
        <div style="min-width:0;">
          <h1 style="margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 70ch;">{{ thread.subject }}</h1>
          <div class="muted" style="margin-top:6px;">Status: {{ thread.get_status_display }}</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn" href="{% url 'messaging:inbox' %}">Back to inbox</a>
          <a class="btn" href="{% url 'dashboard' %}">Dashboard</a>
        </div>
      </div>
    </div>

    <div class="spacer-12"></div>

    <div class="card" style="padding: 0; overflow:hidden;">
      <div style="padding: 14px 16px; border-bottom: 1px solid var(--border);">
        <strong>Conversation</strong>
      </div>

      <div style="padding: 16px; display:grid; gap: 10px;">
        {% if messages_list %}
          {% for m in messages_list %}
            <div style="display:flex; gap:10px; justify-content:{% if m.from_staff %}flex-start{% else %}flex-end{% endif %};">
              <div style="max-width: 820px; width: fit-content;">
                <div class="card" style="padding: 12px; background: {% if m.from_staff %}linear-gradient(180deg, var(--glass-strong), var(--glass)){% else %}linear-gradient(180deg, var(--btn-primary-bg-hover), var(--btn-primary-bg)){% endif %}; border-color: var(--border-strong);">
                  <div style="white-space: pre-wrap;">{{ m.body }}</div>
                </div>
                <div class="muted" style="margin-top:6px; font-size: 12px;">
                  {% if m.from_staff %}Admin{% else %}You{% endif %} · {{ m.created_at|date:"Y-m-d H:i" }}
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div class="muted">No messages yet.</div>
        {% endif %}
      </div>

      <div style="border-top: 1px solid var(--border); padding: 14px 16px;">
        {% if thread.status == 'open' %}
          <form method="post" class="stack" novalidate>
            {% csrf_token %}
            <div>
              <label for="id_message">Your reply</label>
              {{ form.message }}
              {% if form.message.errors %}
                <div class="muted" style="margin-top:6px;">{{ form.message.errors }}</div>
              {% endif %}
            </div>
            <div>
              <button class="btn btn-primary" type="submit">Send reply</button>
            </div>
          </form>
        {% else %}
          <div class="muted">This thread is closed.</div>
        {% endif %}
      </div>
    </div>
  </div>
{% endblock %}
